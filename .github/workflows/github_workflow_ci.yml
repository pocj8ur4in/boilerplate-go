name: CI

on:
    push:
        branches: [main, master, develop]
    pull_request:
        branches: [main, master, develop]

env:
    GO_VERSION: "1.25.0"

permissions:
    contents: read
    security-events: write

jobs:
    lint:
        name: Lint & Test
        runs-on: ubuntu-latest

        services:
            redis:
                image: redis:7-alpine
                ports:
                    - 36379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

            postgres:
                image: postgres:17.4-alpine
                env:
                    POSTGRES_USER: boilerplate_user
                    POSTGRES_PASSWORD: boilerplate_password
                    POSTGRES_DB: boilerplate
                ports:
                    - 35432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v4
              continue-on-error: true
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.mod', '**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Download Go modules
              run: go mod download

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v7
              with:
                  version: latest
                  args: --timeout=10m

            - name: Setup test config
              run: cp config.example.json config.json

            - name: Run Go tests
              run: go test -v -p=1 -parallel=4 -timeout=15m -race -coverprofile=coverage.out -covermode=atomic $(go list ./... | grep -v -e /internal/gen/ -e /cmd/)

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  file: ./coverage.out
                  flags: backend
                  name: codecov-go
                  verbose: true
                  fail_ci_if_error: false

    performance:
        name: Performance Tests
        runs-on: ubuntu-latest
        needs: [lint]

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v4
              continue-on-error: true
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.mod', '**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Download Go modules
              run: go mod download

            - name: Setup test config
              run: cp config.example.json config.json

            - name: Run benchmarks
              run: |
                  go test -bench=. -benchmem -run=^$ $(go list ./... | grep -v /internal/gen/) > benchmark.txt
                  cat benchmark.txt

            - name: Upload benchmark results to Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results
                  path: benchmark.txt
                  retention-days: 30

    security:
        name: Security Scan (Gosec, govulncheck, Trivy)
        runs-on: ubuntu-latest
        needs: [lint]

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v4
              continue-on-error: true
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.mod', '**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install Gosec Security Scanner
              run: |
                  go install github.com/securego/gosec/v2/cmd/gosec@latest

            - name: Run Gosec Security Scanner
              run: gosec -fmt sarif -out gosec-results.sarif -exclude=G101 ./...

            - name: Upload Gosec Security Results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              with:
                  sarif_file: "gosec-results.sarif"

            - name: Run govulncheck
              run: |
                  echo "replace golang.org/x/tools => golang.org/x/tools v0.26.0" >> go.mod
                  go get -u golang.org/x/tools@v0.26.0
                  go mod tidy
                  go env -w GOTOOLCHAIN=local
                  go install golang.org/x/vuln/cmd/govulncheck@latest
                  git checkout go.mod go.sum 2>/dev/null || true
                  govulncheck -json ./... > govulncheck-results.json || true

            - name: Convert govulncheck to SARIF
              run: |
                  echo '{"version": "2.1.0", "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json", "runs": [{"tool": {"driver": {"name": "govulncheck", "version": "v1.1.3"}}, "results": []}]}' > govulncheck-results.sarif

            - name: Upload govulncheck results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              with:
                  sarif_file: "govulncheck-results.sarif"
            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  target: prod
                  push: false
                  load: true
                  tags: pocj8ur4in/boilerplate-go:prod
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "pocj8ur4in/boilerplate-go:prod"
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    build:
        name: Build & Artifacts
        runs-on: ubuntu-latest
        needs: [lint, security]

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.mod', '**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Download Go modules
              run: go mod download

            - name: Build Go Binary
              run: |
                  CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o bin/boilerplate ./cmd/boilerplate/main.go

            - name: Upload Binary to Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-binary
                  path: |
                      bin/boilerplate
                  retention-days: 7
